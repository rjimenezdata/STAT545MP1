---
title: "MP1"
author: "Dillon and Ruben"
code-fold: true
format: html
---

```{r setup}
#| include: false
library(tidyverse)
library(kableExtra)
library(markovchain)
library(rlang)
```

# Preprocessing

## Data Preprocessing

```{r}
#| message: false
# imperial beach station USW00093115
# 12/25/2008 - 1/12/2026
sd <- read.csv("https://www.ncei.noaa.gov/access/past-weather/USW00093115/data.csv", skip = 1) |>
  mutate(Date = as.Date(Date, tryFormats = "%Y-%m-%d")) |>
  filter(Date <= as.Date("2026-01-05"),
         Date >= as.Date("2014-08-01")) |>
  rename(prcp = "PRCP..Inches.",
         temp_max = "TMAX..Degrees.Fahrenheit.") |> 
  select(Date, prcp, temp_max)


# marin county station USC00047880
# 10/31/2008 - 1/21/2026
marin <- read.csv("https://www.ncei.noaa.gov/access/past-weather/USC00047880/data.csv", skip = 1) |>
  mutate(Date = as.Date(Date, tryFormats = "%Y-%m-%d")) |>
  filter(Date <= as.Date("2026-01-05"),
         Date >= as.Date("2014-08-01")) |>
  rename(prcp = "PRCP..Inches.",
         temp_max = "TMAX..Degrees.Fahrenheit.") |> 
  select(Date, prcp, temp_max)

# slo county station USW00093206 
# 10/31/2008 - 1/21/2026
slo <- read_csv('https://www.ncei.noaa.gov/access/past-weather/USW00093206/data.csv', skip = 1) |>
  mutate(Date = as.Date(Date, tryFormats = "%Y-%m-%d")) |>
  filter(Date <= as.Date("2026-01-05"),
         Date >= as.Date("2014-08-01")) |>
  rename(prcp = "PRCP (Inches)",
         temp_max = "TMAX (Degrees Fahrenheit)") |> 
  select(Date, prcp, temp_max)

weather_all <- bind_rows(
  sd    %>% mutate(location = "San Diego"),
  slo   %>% mutate(location = "SLO County"),
  marin %>% mutate(location = "Marin County")
)
```

## Add Rain + Temp + Season States

```{r}
# Rain
# 0 inches = none
# 0 to 0.75 = light
# >= 0.75 = heavy

# Temp
# <63 = cold
# 63-75 = comfortable
# >75 = hot

# Seasons:
# Oct-Mar
# Apr-Sept

add_weathers <- function(df) {
  df %>%
    mutate(
      rain = case_when(
        prcp == 0              ~ "none",
        prcp > 0 & prcp < 0.5    ~ "light",
        prcp >= 0.5              ~ "heavy",
        TRUE                   ~ NA_character_
      ),
      temp = case_when(
        temp_max < 63                   ~ "cold",
        temp_max >= 63 & temp_max <= 75 ~ "comfortable",
        temp_max > 75                   ~ "hot",
        TRUE                            ~ NA_character_
      ),
      season = case_when(
        lubridate::month(Date) %in% c(10,11,12,1,2,3) ~ "Oct–Mar",
        lubridate::month(Date) %in% c(4,5,6,7,8,9)    ~ "Apr–Sep",
        TRUE ~ NA_character_
      ),
      rain = factor(rain, levels = c("none", "light", "heavy")),
      temp = factor(temp, levels = c("cold", "comfortable", "hot")),
      season   = factor(season, levels = c("Oct–Mar", "Apr–Sep"))
    )
}

weather_all <- weather_all |> add_weathers()
```

## Helper Functions

```{r}
state_props <- function(x) {
  tab <- table(x, useNA = "always")
  tibble(
    state = names(tab),
    n     = as.integer(tab),
    prop  = as.numeric(tab / sum(tab))
  )
}

get_table <- function(cat_col, ...) {
  weather_all %>%
    group_by(...) %>%
    summarise(data = list(state_props({{ cat_col }})), .groups = "drop") %>%
    unnest(data)
}

props_kable <- function(df, group_cols, caption_add) {
  by_str <- paste(group_cols, collapse = " and ")
  
  df %>%
    select(all_of(group_cols), state, prop) %>%
    mutate(
      prop = scales::percent(prop, accuracy = 0.01)
    ) %>%
    pivot_wider(
      names_from  = state,
      values_from = prop
    ) %>%
    arrange(across(all_of(group_cols))) %>%
    kable(
      caption = paste0(caption_add, " State Proportions by ", by_str)
    ) %>%
    kable_styling(full_width = FALSE) %>%
    column_spec(1, bold = TRUE)
}

fit_markov_on_nonmissing_blocks <- function(x) {
  x <- as.vector(x)
  is_miss  <- is.na(x)
  block_id <- cumsum(is_miss != dplyr::lag(is_miss, default = FALSE))
  blocks <- split(x, block_id)
  blocks <- lapply(blocks, \(b) b[!is.na(b)])
  blocks <- Filter(\(b) length(b) > 2, blocks)
  markovchainFit(data = blocks, method = "mle")
}

markov_report <- function(cat_col, group_cols = c("location")) {
  fit_tbl <- weather_all %>%
    group_by(across(all_of(group_cols))) %>%
    summarise(seq = list(.data[[cat_col]]), .groups = "drop") %>%
    mutate(
      fit   = map(seq, fit_markov_on_nonmissing_blocks),
      chain = map(fit, "estimate")
    )

  trans_out <- vector("list", nrow(fit_tbl))
  tbl_out   <- vector("list", nrow(fit_tbl))

  for (i in seq_len(nrow(fit_tbl))) {
    row <- fit_tbl[i, ]
    chain <- row$chain[[1]]

    grp_vals <- row %>%
      select(all_of(group_cols)) %>%
      mutate(across(everything(), as.character))

    seq_vec <- row$seq[[1]] %>%
      as.factor() %>%
      fct_na_value_to_level(level = "unobserved")

    # adequacy: transition count matrix + row sums
    transition_counts <- createSequenceMatrix(seq_vec)
    row_totals <- rowSums(transition_counts)

    adequacy_tbl <- tibble(
      state = names(row_totals),
      outgoing_transitions = as.integer(row_totals)
    )

    # stationary + return times
    pi <- as.numeric(steadyStates(chain)[1, ])
    names(pi) <- states(chain)

    steady_tbl <- tibble(
      state = names(pi),
      stationary = pi,
      expected_return_time = 1 / pi
    )

    tbl_out[[i]] <- bind_cols(
      grp_vals[rep(1, nrow(steady_tbl)), ],
      left_join(steady_tbl, adequacy_tbl, by = "state")
    )

    # transition matrix
    trans_long <- as.data.frame(chain@transitionMatrix) %>%
      rownames_to_column("from") %>%
      pivot_longer(-from, names_to = "to", values_to = "p")

    trans_out[[i]] <- bind_cols(grp_vals, trans_long)
  }

  summary_tbl <- bind_rows(tbl_out) %>%
    arrange(across(all_of(group_cols)), state)

  tbl_kable <- summary_tbl %>%
    kable(
      digits = 4,
      caption = paste0(cat_col, ": adequacy (outgoing transitions), stationary π, and expected return times")
    ) %>%
    kable_styling(full_width = FALSE)

  trans_df <- bind_rows(trans_out)

  p <- trans_df %>%
    ggplot(aes(x = to, y = from, fill = p)) +
    geom_tile(color = "white") +
    geom_text(aes(label = sprintf("%.2f", p)), size = 3) +
    labs(
      title = paste0(cat_col, " transition matrices by ", paste(group_cols, collapse = " × ")),
      x = "To", y = "From", fill = "P"
    ) +
    theme_minimal(base_size = 12)

  if (length(group_cols) == 1) {
    p <- p + facet_wrap(as.formula(paste0("~", group_cols[1])))
  } else if (length(group_cols) == 2) {
    p <- p + facet_grid(as.formula(paste0(group_cols[2], " ~ ", group_cols[1])))
  }

  return(list(table = tbl_kable, plot = p))
}
```

# Part 1: Location

## Summary Table of Days in Each State

### Rainy Days

```{r}
rain_props_loc <- get_table(rain, location)

rain_props_loc %>%
  props_kable(c("location"), "Rain")

rain_props_loc %>%
  ggplot(aes(x = location, y = prop, fill = state)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Rain state composition by location", x = NULL, y = "Proportion of days", fill = "State") +
  theme_minimal(base_size = 12)
```

-   We defined no rain as 0 inches of rain, light rain as between 0 and 1 inch of rain, and heavy rain as more than 1 inch of rain.
-   San Diego seems to be driest overall when we normalize for nonmissing values. About 94% of all observed days were dry, compared to 89% for SLO and 84% for Marin.
-   Marin experiences more light and heavy rain. It rained on about 16% of all observed days in Marin, 11% of all observed days in SLO and 6% of all observed days in San Diego when normalized for nonmissing values.

### Temperature

```{r}
temp_props_loc <- get_table(temp, location)

temp_props_loc %>%
  props_kable(c("location"), "Temp")

temp_props_loc %>%
  ggplot(aes(x = location, y = prop, fill = state)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Rain state composition by location", x = NULL, y = "Proportion of days", fill = "State") +
  theme_minimal(base_size = 12)
```

-   We defined cold days as having maximum daily temperature less than 63 degrees, comfortable days being between 63 to 75 degrees at maximum, and hot days having greater than 75 degrees maximum.

-   Marin has highest proportion of cold days at almost 24% when normalized, compared to 12% for SLO and 6% for San Diego. This makes sense with how far north and coastal it is.

-   San Diego has the highest proportion of comfortable days. When normalized it is almost 69%, compared to 46% for SLO and about 36% for Marin.

## Fit Markov Models

### Rain Behavior

```{r}
out <- markov_report("rain", c("location"))
out$table
out$plot
```

-   San Diego has an extremely expected long return time for heavy rain, at 178 days cumulatively.

-   Marin has the most frequent transitions to rainy states.

-   The "no rain" state is highly persistent for all locations. Additionally, across all three locations, we can observe that it is most likely to rain lightly after it has just rained heavily. In all three locations, it is most likely to stop raining after it has just rained lightly.

### Temperature Behavior

```{r}
out <- markov_report("temp", c("location"))
out$table
out$plot
```

-   Temperature states are all highly persistent (as seen on diagonal).

-   San Diego has over double the return time to a cold state as the next longest return time to cold, which is SLO.

-   Marin is most likely to have streaks of hot days compared to the other two locations. San Diego is most likely to have streaks of comfortable days.

# Part 2: Location x Season

## Summary Table of Days in Each State

### Rain

```{r}
rain_props_loc_season <- get_table(rain, location, season)

rain_props_loc_season %>%
  props_kable(c("location", "season"), "Rain")

rain_props_loc_season %>%
  ggplot(aes(x = season, y = prop, fill = state)) +
  geom_col() +
  facet_wrap(~ location, ncol = 2) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Rain state composition by location and season", x = NULL, y = "Proportion of days", fill = "State") +
  theme_minimal(base_size = 12)
```

-   Patterns dominated by seasonality for all locations.

-   Much rainier in Oct-March compared to Apr-Sept.

-   San Diego manages to stay dry year round, but very high proportion of missing data in Oct-March.

### Temperature

```{r}
temp_props_loc_season <- get_table(temp, location, season)

temp_props_loc_season %>%
  props_kable(c("location", "season"), "Temp")

temp_props_loc_season %>%
  ggplot(aes(x = season, y = prop, fill = state)) +
  geom_col() +
  facet_wrap(~ location, ncol = 2) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Temperature state composition by location and season", x = NULL, y = "Proportion of days", fill = "State") +
  theme_minimal(base_size = 12)
```

-   Once again, patterns strongly dominated by seasonality.

-   As expected, more hot days in summer and cold days in winter, with San Diego standing out as best weather once again.

-   Marin appears to be hot proportionally more than the other locations based on the observed data during the summer.

## Fit Markov Models

### Rain

```{r}
out <- markov_report("rain", c("location", "season"))
out$table
out$plot
```

-   The heavy rain returns times in Apr-Sept are impossibly long, especially for San Diego (759).

-   In winter, Marin County specifically has a large increase in estimated rainy states

-   Across all three locations, transition to no rain from a rainy state during the summer is more likely than the winter.

### Temperature

```{r}
out <- markov_report("temp", c("location", "season"))
out$table
out$plot
```

-   Temperature persistence occurs once again during the winter, but not as strongly during the summer.

-   During summer hot to hot persistence is extremely high. This means there are more likely to be streaks of hot days.

-   San Diego has the most persistence in the comfortable state across both seasons.

-   The expected return time for the cold state in San Diego summers is very long (118). The next longest expected return time for the cold state is in about 35 in Marin, meaning cold days are much more common in Marin and SLO summers than in San Diego.
